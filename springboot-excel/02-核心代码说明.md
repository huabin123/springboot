# 02-æ ¸å¿ƒä»£ç è¯´æ˜

## ğŸ“Œ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è§£æé¡¹ç›®ä¸­çš„æ ¸å¿ƒä»£ç å®ç°ï¼ŒåŒ…æ‹¬è®¾è®¡æ€è·¯ã€å…³é”®æŠ€æœ¯ç‚¹å’Œæœ€ä½³å®è·µã€‚

---

## ğŸ—ï¸ é¡¹ç›®ç»“æ„

```
springboot-excel/
â”œâ”€â”€ src/main/java/com/huabin/excel/export/
â”‚   â”œâ”€â”€ ExcelExportApplication.java          # å¯åŠ¨ç±»
â”‚   â”œâ”€â”€ constant/
â”‚   â”‚   â””â”€â”€ ExcelConstants.java              # å¸¸é‡å®šä¹‰
â”‚   â”œâ”€â”€ controller/
â”‚   â”‚   â””â”€â”€ ExcelExportController.java       # æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ model/
â”‚   â”‚   â””â”€â”€ HeaderMapping.java               # è¡¨å¤´æ˜ å°„å®ä½“
â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”œâ”€â”€ ExcelExportService.java          # å¯¼å‡ºæœåŠ¡
â”‚   â”‚   â””â”€â”€ MockDataService.java             # æ•°æ®æ¨¡æ‹ŸæœåŠ¡
â”‚   â””â”€â”€ util/
â”‚       â””â”€â”€ ExcelExportUtil.java             # å¯¼å‡ºå·¥å…·ç±»
â”œâ”€â”€ src/main/resources/
â”‚   â””â”€â”€ application.yml                       # é…ç½®æ–‡ä»¶
â””â”€â”€ pom.xml                                   # Maven ä¾èµ–
```

---

## ğŸ“¦ æ ¸å¿ƒç±»è¯¦è§£

### 1. HeaderMapping - è¡¨å¤´æ˜ å°„å®ä½“ç±»

**è®¾è®¡ç›®çš„**ï¼š
- å®šä¹‰æ•°æ®åº“å­—æ®µï¼ˆè‹±æ–‡ï¼‰åˆ° Excel è¡¨å¤´ï¼ˆä¸­æ–‡ï¼‰çš„æ˜ å°„å…³ç³»
- ä¿è¯å­—æ®µé¡ºåºå’Œè¡¨å¤´æ˜¾ç¤ºçš„ä¸€è‡´æ€§
- ä¾¿äºé›†ä¸­ç®¡ç†å’Œç»´æŠ¤æ˜ å°„é…ç½®

**æ ¸å¿ƒå­—æ®µ**ï¼š

```java
public class HeaderMapping implements Serializable {
    
    /**
     * è‹±æ–‡å­—æ®µåï¼ˆæ•°æ®åº“å­—æ®µåï¼‰
     * ç”¨äºä» LinkedHashMap ä¸­å–å€¼
     */
    private String englishName;
    
    /**
     * ä¸­æ–‡å­—æ®µåï¼ˆExcel è¡¨å¤´åç§°ï¼‰
     * ç”¨äº Excel è¡¨å¤´æ˜¾ç¤º
     */
    private String chineseName;
    
    // æ„é€ å‡½æ•°ã€getterã€setter...
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```java
// åˆ›å»ºæ˜ å°„
HeaderMapping mapping = new HeaderMapping("orderNo", "è®¢å•ç¼–å·");

// æ‰¹é‡åˆ›å»º
List<HeaderMapping> mappings = new ArrayList<>();
mappings.add(new HeaderMapping("orderNo", "è®¢å•ç¼–å·"));
mappings.add(new HeaderMapping("customerName", "å®¢æˆ·å§“å"));
mappings.add(new HeaderMapping("amount", "è®¢å•é‡‘é¢"));
```

**è®¾è®¡è¦ç‚¹**ï¼š
- âœ… å®ç° `Serializable` æ¥å£ï¼Œæ”¯æŒåºåˆ—åŒ–
- âœ… æä¾›æ— å‚å’Œå…¨å‚æ„é€ å‡½æ•°ï¼Œä¾¿äºä½¿ç”¨
- âœ… å­—æ®µå‘½åæ¸…æ™°ï¼Œæ˜“äºç†è§£
- âœ… åˆ—è¡¨é¡ºåºå†³å®š Excel åˆ—é¡ºåº

---

### 2. ExcelConstants - å¸¸é‡å®šä¹‰ç±»

**è®¾è®¡ç›®çš„**ï¼š
- é›†ä¸­ç®¡ç†æ‰€æœ‰å¸¸é‡
- é¿å…é­”æ³•æ•°å­—
- ä¾¿äºç»´æŠ¤å’Œä¿®æ”¹

**æ ¸å¿ƒå¸¸é‡**ï¼š

```java
public class ExcelConstants {
    
    /**
     * æœ€å¤§å¯¼å‡ºæ•°æ®æ¡æ•°
     * 
     * è®¾è®¡è€ƒè™‘ï¼š
     * 1. å†…å­˜é™åˆ¶ï¼š10ä¸‡æ¡æ•°æ®çº¦å ç”¨ 500MB å†…å­˜
     * 2. æ€§èƒ½è€ƒè™‘ï¼šå¯¼å‡ºæ—¶é—´çº¦ 5ç§’ï¼Œç”¨æˆ·å¯æ¥å—
     * 3. Excel é™åˆ¶ï¼šExcel 2007+ æœ€å¤§æ”¯æŒ 1048576 è¡Œ
     * 4. ä¸šåŠ¡éœ€æ±‚ï¼šè¶…è¿‡æ­¤æ•°é‡å»ºè®®åˆ†æ‰¹æˆ–å¼‚æ­¥å¤„ç†
     */
    public static final int MAX_EXPORT_ROWS = 100000;
    
    /**
     * å“åº”å¤´ - æ•°æ®è¶…é•¿è­¦å‘Š
     * 
     * ç”¨é€”ï¼šå½“æ•°æ®é‡è¶…è¿‡ MAX_EXPORT_ROWS æ—¶ï¼Œåœ¨æ­¤å“åº”å¤´ä¸­è¿”å›è­¦å‘Šä¿¡æ¯
     * ç¤ºä¾‹ï¼šX-Data-Overflow: æ•°æ®æ€»é‡ 150000 æ¡ï¼Œå·²æˆªæ–­ä¸ºå‰ 100000 æ¡
     */
    public static final String HEADER_DATA_OVERFLOW = "X-Data-Overflow";
    
    /**
     * å“åº”å¤´ - å®é™…æ•°æ®æ€»æ•°
     * 
     * ç”¨é€”ï¼šå‘ŠçŸ¥å®¢æˆ·ç«¯æ•°æ®åº“ä¸­çš„å®é™…æ•°æ®æ€»é‡
     * ç¤ºä¾‹ï¼šX-Total-Count: 150000
     */
    public static final String HEADER_TOTAL_COUNT = "X-Total-Count";
    
    /**
     * å“åº”å¤´ - å¯¼å‡ºæ•°æ®æ¡æ•°
     * 
     * ç”¨é€”ï¼šå‘ŠçŸ¥å®¢æˆ·ç«¯æœ¬æ¬¡å®é™…å¯¼å‡ºçš„æ•°æ®æ¡æ•°
     * ç¤ºä¾‹ï¼šX-Export-Count: 100000
     */
    public static final String HEADER_EXPORT_COUNT = "X-Export-Count";
    
    // ... å…¶ä»–å¸¸é‡
}
```

**æœ€ä½³å®è·µ**ï¼š
- âœ… ä½¿ç”¨ `public static final` å®šä¹‰å¸¸é‡
- âœ… æ·»åŠ è¯¦ç»†çš„æ³¨é‡Šè¯´æ˜
- âœ… ç§æœ‰æ„é€ å‡½æ•°é˜²æ­¢å®ä¾‹åŒ–
- âœ… æŒ‰åŠŸèƒ½åˆ†ç»„ç»„ç»‡å¸¸é‡

---

### 3. MockDataService - æ•°æ®æ¨¡æ‹ŸæœåŠ¡

**è®¾è®¡ç›®çš„**ï¼š
- æ¨¡æ‹ŸçœŸå®çš„æ•°æ®åº“æŸ¥è¯¢ï¼ˆè¿”å›è‹±æ–‡å­—æ®µåï¼‰
- ç”Ÿæˆæµ‹è¯•æ•°æ®
- æä¾›è¡¨å¤´æ˜ å°„é…ç½®
- ä¾¿äºåŠŸèƒ½æ¼”ç¤ºå’Œæµ‹è¯•

**æ ¸å¿ƒæ–¹æ³•**ï¼š

#### 3.1 queryData() - æŸ¥è¯¢æ•°æ®ï¼ˆè¿”å›è‹±æ–‡å­—æ®µåï¼‰

```java
public List<LinkedHashMap<String, Object>> queryData(int count) {
    logger.info("å¼€å§‹æ¨¡æ‹ŸæŸ¥è¯¢æ•°æ®ï¼Œæ•°æ®é‡: {}", count);
    
    long startTime = System.currentTimeMillis();
    
    // 1. é¢„åˆ†é…å®¹é‡ï¼Œé¿å…æ‰©å®¹å¼€é”€
    List<LinkedHashMap<String, Object>> dataList = new ArrayList<>(count);
    
    // 2. å¾ªç¯ç”Ÿæˆæ•°æ®ï¼ˆä½¿ç”¨è‹±æ–‡å­—æ®µåï¼Œæ¨¡æ‹ŸçœŸå®æ•°æ®åº“ï¼‰
    for (int i = 1; i <= count; i++) {
        LinkedHashMap<String, Object> row = new LinkedHashMap<>();
        
        // 3. ä½¿ç”¨è‹±æ–‡å­—æ®µåï¼ˆæ¨¡æ‹Ÿæ•°æ®åº“å­—æ®µï¼‰
        row.put("orderNo", "ORD" + String.format("%010d", i));
        row.put("customerName", generateCustomerName(i));
        row.put("phone", generatePhone(i));
        row.put("amount", generateAmount(i));
        row.put("status", generateStatus(i));
        row.put("orderTime", generateDateTime(i));
        row.put("address", generateAddress(i));
        row.put("productName", generateProductName(i));
        row.put("quantity", generateQuantity(i));
        row.put("remark", generateRemark(i));
        
        dataList.add(row);
        
        // 4. å®šæœŸæ‰“å°è¿›åº¦ï¼ˆæ¯1ä¸‡æ¡ï¼‰
        if (i % 10000 == 0) {
            logger.info("æ•°æ®ç”Ÿæˆè¿›åº¦: {}/{}", i, count);
        }
    }
    
    long endTime = System.currentTimeMillis();
    logger.info("æ•°æ®æŸ¥è¯¢å®Œæˆï¼Œæ•°æ®é‡: {}, è€—æ—¶: {}ms", count, (endTime - startTime));
    
    return dataList;
}
```

#### 3.2 getHeaderMappings() - è·å–è¡¨å¤´æ˜ å°„é…ç½®

```java
public List<HeaderMapping> getHeaderMappings() {
    List<HeaderMapping> mappings = new ArrayList<>();
    
    // æŒ‰ç…§æœŸæœ›çš„ Excel åˆ—é¡ºåºæ·»åŠ æ˜ å°„
    mappings.add(new HeaderMapping("orderNo", "è®¢å•ç¼–å·"));
    mappings.add(new HeaderMapping("customerName", "å®¢æˆ·å§“å"));
    mappings.add(new HeaderMapping("phone", "è”ç³»ç”µè¯"));
    mappings.add(new HeaderMapping("amount", "è®¢å•é‡‘é¢"));
    mappings.add(new HeaderMapping("status", "è®¢å•çŠ¶æ€"));
    mappings.add(new HeaderMapping("orderTime", "ä¸‹å•æ—¶é—´"));
    mappings.add(new HeaderMapping("address", "æ”¶è´§åœ°å€"));
    mappings.add(new HeaderMapping("productName", "å•†å“åç§°"));
    mappings.add(new HeaderMapping("quantity", "å•†å“æ•°é‡"));
    mappings.add(new HeaderMapping("remark", "å¤‡æ³¨ä¿¡æ¯"));
    
    return mappings;
}
```

**å…³é”®æŠ€æœ¯ç‚¹**ï¼š

1. **ä½¿ç”¨è‹±æ–‡å­—æ®µåï¼ˆæ¨¡æ‹ŸçœŸå®æ•°æ®åº“ï¼‰**
   ```java
   // æ•°æ®åº“å­—æ®µé€šå¸¸æ˜¯è‹±æ–‡
   row.put("orderNo", "ORD0000000001");      // è€Œä¸æ˜¯ "è®¢å•ç¼–å·"
   row.put("customerName", "å¼ ä¼Ÿ");           // è€Œä¸æ˜¯ "å®¢æˆ·å§“å"
   ```

2. **è¡¨å¤´æ˜ å°„é…ç½®**
   ```java
   // å®šä¹‰è‹±æ–‡åˆ°ä¸­æ–‡çš„æ˜ å°„å…³ç³»
   // åˆ—è¡¨é¡ºåºå†³å®š Excel åˆ—é¡ºåº
   List<HeaderMapping> mappings = new ArrayList<>();
   mappings.add(new HeaderMapping("orderNo", "è®¢å•ç¼–å·"));
   mappings.add(new HeaderMapping("customerName", "å®¢æˆ·å§“å"));
   ```

3. **é¢„åˆ†é…å®¹é‡ä¼˜åŒ–æ€§èƒ½**
   ```java
   // é¿å… ArrayList æ‰©å®¹å¸¦æ¥çš„æ€§èƒ½å¼€é”€
   List<LinkedHashMap<String, Object>> dataList = new ArrayList<>(count);
   ```

4. **è¿›åº¦ç›‘æ§**
   ```java
   // å¤§æ•°æ®é‡ç”Ÿæˆæ—¶ï¼Œå®šæœŸæ‰“å°è¿›åº¦
   if (i % 10000 == 0) {
       logger.info("æ•°æ®ç”Ÿæˆè¿›åº¦: {}/{}", i, count);
   }
   ```

#### 3.3 æ•°æ®ç”Ÿæˆæ–¹æ³•

```java
/**
 * ç”Ÿæˆå®¢æˆ·å§“å
 * 
 * ç­–ç•¥ï¼šä½¿ç”¨å§“æ°å’Œåå­—æ•°ç»„å¾ªç¯ç»„åˆ
 * ä¼˜ç‚¹ï¼šæ•°æ®å¤šæ ·æ€§ï¼Œé¿å…é‡å¤
 */
private String generateCustomerName(int index) {
    String[] surnames = {"å¼ ", "ç‹", "æ", "èµµ", "åˆ˜", "é™ˆ", "æ¨", "é»„", "å‘¨", "å´"};
    String[] names = {"ä¼Ÿ", "èŠ³", "å¨œ", "ç§€è‹±", "æ•", "é™", "ä¸½", "å¼º", "ç£Š", "å†›"};
    
    int surnameIndex = index % surnames.length;
    int nameIndex = (index / surnames.length) % names.length;
    
    return surnames[surnameIndex] + names[nameIndex];
}

/**
 * ç”Ÿæˆè®¢å•é‡‘é¢
 * 
 * ç­–ç•¥ï¼šåŸºç¡€é‡‘é¢ + åŠ¨æ€å¢é‡
 * ä¼˜ç‚¹ï¼šæ•°æ®çœŸå®ï¼Œæœ‰è§„å¾‹å˜åŒ–
 */
private BigDecimal generateAmount(int index) {
    double amount = 10.0 + (index % 10000) * 0.99;
    return new BigDecimal(String.format("%.2f", amount));
}
```

**å®é™…é¡¹ç›®æ›¿æ¢æ–¹æ¡ˆ**ï¼š

```java
// æ›¿æ¢ä¸ºå®é™…çš„æ•°æ®åº“æŸ¥è¯¢
@Service
public class OrderDataService {
    
    @Autowired
    private OrderMapper orderMapper;
    
    /**
     * æŸ¥è¯¢è®¢å•æ•°æ®ï¼ˆè¿”å›è‹±æ–‡å­—æ®µåï¼‰
     */
    public List<LinkedHashMap<String, Object>> queryOrders(QueryParam param) {
        // 1. ä»æ•°æ®åº“æŸ¥è¯¢
        List<Order> orders = orderMapper.selectByParam(param);
        
        // 2. è½¬æ¢ä¸º LinkedHashMapï¼ˆä½¿ç”¨è‹±æ–‡å­—æ®µåï¼‰
        List<LinkedHashMap<String, Object>> result = new ArrayList<>();
        for (Order order : orders) {
            LinkedHashMap<String, Object> row = new LinkedHashMap<>();
            row.put("orderNo", order.getOrderNo());
            row.put("customerName", order.getCustomerName());
            row.put("amount", order.getAmount());
            row.put("status", order.getStatus());
            row.put("orderTime", order.getCreateTime());
            // ... å…¶ä»–å­—æ®µ
            result.add(row);
        }
        
        return result;
    }
    
    /**
     * è·å–è¡¨å¤´æ˜ å°„é…ç½®
     */
    public List<HeaderMapping> getHeaderMappings() {
        List<HeaderMapping> mappings = new ArrayList<>();
        mappings.add(new HeaderMapping("orderNo", "è®¢å•ç¼–å·"));
        mappings.add(new HeaderMapping("customerName", "å®¢æˆ·å§“å"));
        mappings.add(new HeaderMapping("amount", "è®¢å•é‡‘é¢"));
        mappings.add(new HeaderMapping("status", "è®¢å•çŠ¶æ€"));
        mappings.add(new HeaderMapping("orderTime", "ä¸‹å•æ—¶é—´"));
        return mappings;
    }
}
```

---

### 4. ExcelExportUtil - å¯¼å‡ºå·¥å…·ç±»

**è®¾è®¡ç›®çš„**ï¼š
- å°è£… EasyExcel å¯¼å‡ºé€»è¾‘
- å¤„ç†å“åº”å¤´è®¾ç½®
- å¤„ç†æ•°æ®æˆªæ–­
- æ”¯æŒè¡¨å¤´æ˜ å°„ï¼ˆè‹±æ–‡å­—æ®µ -> ä¸­æ–‡è¡¨å¤´ï¼‰
- å¤„ç†ä¸­æ–‡æ–‡ä»¶å

**æ ¸å¿ƒæ–¹æ³•**ï¼š

#### 4.1 exportToResponse() - å¯¼å‡ºåˆ°å“åº”æµï¼ˆæ”¯æŒè¡¨å¤´æ˜ å°„ï¼‰

```java
public static void exportToResponse(HttpServletResponse response,
                                   List<LinkedHashMap<String, Object>> dataList,
                                   List<HeaderMapping> headerMappings,
                                   String fileName,
                                   String sheetName) throws IOException {
    
    // 1. æ•°æ®æ ¡éªŒ
    if (dataList == null || dataList.isEmpty()) {
        logger.warn("å¯¼å‡ºæ•°æ®ä¸ºç©º");
        throw new IllegalArgumentException("å¯¼å‡ºæ•°æ®ä¸èƒ½ä¸ºç©º");
    }

    // 2. è®°å½•åŸå§‹æ•°æ®æ€»æ•°
    int totalCount = dataList.size();
    logger.info("å¼€å§‹å¯¼å‡º Excelï¼ŒåŸå§‹æ•°æ®é‡: {}", totalCount);

    // 3. æ£€æŸ¥æ•°æ®æ˜¯å¦è¶…é•¿
    boolean isOverflow = totalCount > ExcelConstants.MAX_EXPORT_ROWS;
    int exportCount = isOverflow ? ExcelConstants.MAX_EXPORT_ROWS : totalCount;

    // 4. å¦‚æœæ•°æ®è¶…é•¿ï¼Œæˆªæ–­æ•°æ®
    List<LinkedHashMap<String, Object>> exportData = dataList;
    if (isOverflow) {
        exportData = dataList.subList(0, ExcelConstants.MAX_EXPORT_ROWS);
        logger.warn("æ•°æ®é‡è¶…è¿‡æœ€å¤§é™åˆ¶ {}ï¼Œå®é™…æ•°æ®é‡: {}ï¼Œå°†åªå¯¼å‡ºå‰ {} æ¡", 
                   ExcelConstants.MAX_EXPORT_ROWS, totalCount, exportCount);
    }

    // 5. è®¾ç½®å“åº”å¤´
    setResponseHeaders(response, fileName, totalCount, exportCount, isOverflow);

    // 6. å¯¼å‡º Excel
    OutputStream outputStream = null;
    try {
        outputStream = response.getOutputStream();

        // æå–ä¸­æ–‡è¡¨å¤´ï¼ˆç”¨äº Excel æ˜¾ç¤ºï¼‰
        List<String> chineseHeaders = extractChineseHeaders(headerMappings);
        logger.info("Excel è¡¨å¤´ï¼ˆä¸­æ–‡ï¼‰: {}", chineseHeaders);

        // æå–è‹±æ–‡å­—æ®µåï¼ˆç”¨äºä»æ•°æ®ä¸­å–å€¼ï¼‰
        List<String> englishFields = extractEnglishFields(headerMappings);
        logger.info("æ•°æ®å­—æ®µï¼ˆè‹±æ–‡ï¼‰: {}", englishFields);

        // è½¬æ¢æ•°æ®æ ¼å¼ï¼ˆæŒ‰ç…§æ˜ å°„é¡ºåºï¼‰
        List<List<Object>> excelData = convertToExcelDataWithMapping(exportData, englishFields);

        // ä½¿ç”¨ EasyExcel å¯¼å‡º
        long startTime = System.currentTimeMillis();
        
        ExcelWriterBuilder writerBuilder = EasyExcel.write(outputStream);
        ExcelWriterSheetBuilder sheetBuilder = writerBuilder.sheet(sheetName);
        
        // è®¾ç½®è¡¨å¤´ï¼ˆä¸­æ–‡ï¼‰
        sheetBuilder.head(convertHeadersToList(chineseHeaders));
        
        // å†™å…¥æ•°æ®
        sheetBuilder.doWrite(excelData);

        long endTime = System.currentTimeMillis();
        logger.info("Excel å¯¼å‡ºæˆåŠŸï¼Œå¯¼å‡ºæ•°æ®é‡: {}, è€—æ—¶: {}ms", exportCount, (endTime - startTime));

    } finally {
        // 7. èµ„æºé‡Šæ”¾
        if (outputStream != null) {
            outputStream.flush();
            outputStream.close();
        }
    }
}
```

**å…³é”®æŠ€æœ¯ç‚¹**ï¼š

1. **æ•°æ®æˆªæ–­é€»è¾‘**
   ```java
   // ä½¿ç”¨ subList æˆªæ–­ï¼Œä¸åˆ›å»ºæ–°åˆ—è¡¨ï¼ŒèŠ‚çœå†…å­˜
   if (isOverflow) {
       exportData = dataList.subList(0, ExcelConstants.MAX_EXPORT_ROWS);
   }
   ```

2. **å“åº”å¤´è®¾ç½®**
   ```java
   private static void setResponseHeaders(HttpServletResponse response,
                                         String fileName,
                                         int totalCount,
                                         int exportCount,
                                         boolean isOverflow) throws UnsupportedEncodingException {
       
       // 1. è®¾ç½® Content-Type
       response.setContentType("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
       response.setCharacterEncoding("UTF-8");

       // 2. è®¾ç½®æ–‡ä»¶åï¼ˆURL ç¼–ç ï¼Œè§£å†³ä¸­æ–‡ä¹±ç ï¼‰
       String encodedFileName = URLEncoder.encode(fileName, "UTF-8")
               .replaceAll("\\+", "%20");  // ç©ºæ ¼ç¼–ç ä¸º %20 è€Œä¸æ˜¯ +
       String fullFileName = encodedFileName + ".xlsx";
       
       // 3. è®¾ç½® Content-Dispositionï¼ˆå…¼å®¹å¤šç§æµè§ˆå™¨ï¼‰
       response.setHeader("Content-Disposition", 
                         "attachment;filename=" + fullFileName + ";filename*=utf-8''" + fullFileName);

       // 4. è®¾ç½®è‡ªå®šä¹‰å“åº”å¤´
       response.setHeader("X-Total-Count", String.valueOf(totalCount));
       response.setHeader("X-Export-Count", String.valueOf(exportCount));

       // 5. å¦‚æœæ•°æ®è¶…é•¿ï¼Œè®¾ç½®è­¦å‘Šä¿¡æ¯
       if (isOverflow) {
           String warningMessage = String.format("æ•°æ®æ€»é‡ %d æ¡ï¼Œè¶…è¿‡æœ€å¤§å¯¼å‡ºé™åˆ¶ %d æ¡ï¼Œå·²æˆªæ–­ä¸ºå‰ %d æ¡",
                                                totalCount, ExcelConstants.MAX_EXPORT_ROWS, exportCount);
           response.setHeader("X-Data-Overflow", 
                             URLEncoder.encode(warningMessage, "UTF-8"));
       }
   }
   ```

3. **ä¸­æ–‡æ–‡ä»¶åå¤„ç†**
   ```java
   // é—®é¢˜ï¼šæµè§ˆå™¨ä¸‹è½½æ—¶ä¸­æ–‡æ–‡ä»¶åä¹±ç 
   // è§£å†³ï¼šURL ç¼–ç  + filename* å‚æ•°
   
   String encodedFileName = URLEncoder.encode(fileName, "UTF-8")
           .replaceAll("\\+", "%20");  // å°† + æ›¿æ¢ä¸º %20
   
   // å…¼å®¹å¤šç§æµè§ˆå™¨çš„å†™æ³•
   response.setHeader("Content-Disposition", 
       "attachment;filename=" + encodedFileName + ".xlsx" +  // æ—§ç‰ˆæµè§ˆå™¨
       ";filename*=utf-8''" + encodedFileName + ".xlsx");    // æ–°ç‰ˆæµè§ˆå™¨ï¼ˆRFC 5987ï¼‰
   ```

4. **åŠ¨æ€è¡¨å¤´æå–**
   ```java
   private static List<String> extractHeaders(List<LinkedHashMap<String, Object>> dataList) {
       if (dataList == null || dataList.isEmpty()) {
           throw new IllegalArgumentException("æ•°æ®åˆ—è¡¨ä¸èƒ½ä¸ºç©º");
       }
       
       // LinkedHashMap çš„ keySet() ä¿è¯äº†é¡ºåº
       LinkedHashMap<String, Object> firstRow = dataList.get(0);
       return new ArrayList<>(firstRow.keySet());
   }
   ```

5. **æ•°æ®æ ¼å¼è½¬æ¢**
   ```java
   private static List<List<Object>> convertToExcelData(
           List<LinkedHashMap<String, Object>> dataList,
           List<String> headers) {
       
       List<List<Object>> excelData = new ArrayList<>();
       
       for (LinkedHashMap<String, Object> row : dataList) {
           List<Object> rowData = new ArrayList<>();
           
           // æŒ‰è¡¨å¤´é¡ºåºæå–å€¼
           for (String header : headers) {
               Object value = row.get(header);
               rowData.add(value != null ? value : "");  // null è½¬ä¸ºç©ºå­—ç¬¦ä¸²
           }
           
           excelData.add(rowData);
       }
       
       return excelData;
   }
   ```

6. **èµ„æºç®¡ç†**
   ```java
   OutputStream outputStream = null;
   try {
       outputStream = response.getOutputStream();
       // å¯¼å‡ºé€»è¾‘...
   } finally {
       // ç¡®ä¿æµè¢«å…³é—­ï¼Œé¿å…èµ„æºæ³„éœ²
       if (outputStream != null) {
           outputStream.flush();
           outputStream.close();
       }
   }
   ```

---

### 4. ExcelExportService - å¯¼å‡ºæœåŠ¡

**è®¾è®¡ç›®çš„**ï¼š
- ä¸šåŠ¡é€»è¾‘ç¼–æ’
- å‚æ•°æ ¡éªŒå’Œé»˜è®¤å€¼è®¾ç½®
- åè°ƒå„å±‚è°ƒç”¨

**æ ¸å¿ƒæ–¹æ³•**ï¼š

```java
public void exportData(HttpServletResponse response, 
                      Integer count, 
                      String fileName, 
                      String sheetName) throws IOException {
    
    logger.info("========================================");
    logger.info("å¼€å§‹æ‰§è¡Œ Excel å¯¼å‡º");
    logger.info("è¯·æ±‚æ•°æ®é‡: {}", count);
    logger.info("æ–‡ä»¶å: {}", fileName);
    logger.info("Sheetåç§°: {}", sheetName);
    logger.info("========================================");

    try {
        // 1. å‚æ•°æ ¡éªŒå’Œé»˜è®¤å€¼è®¾ç½®
        count = validateAndSetDefaultCount(count);
        fileName = validateAndSetDefaultFileName(fileName);
        sheetName = validateAndSetDefaultSheetName(sheetName);

        // 2. æŸ¥è¯¢æ•°æ®ï¼ˆæ¨¡æ‹Ÿä»æ•°æ®åº“æŸ¥è¯¢ï¼‰
        List<LinkedHashMap<String, Object>> dataList = mockDataService.queryData(count);

        // 3. æ‰§è¡Œå¯¼å‡º
        ExcelExportUtil.exportToResponse(response, dataList, fileName, sheetName);

        logger.info("Excel å¯¼å‡ºå®Œæˆ");
        logger.info("========================================");

    } catch (Exception e) {
        logger.error("Excel å¯¼å‡ºå¤±è´¥", e);
        throw e;
    }
}
```

**å‚æ•°æ ¡éªŒé€»è¾‘**ï¼š

```java
/**
 * æ ¡éªŒå¹¶è®¾ç½®é»˜è®¤æ•°æ®æ¡æ•°
 */
private Integer validateAndSetDefaultCount(Integer count) {
    // 1. ç©ºå€¼æˆ–éæ³•å€¼å¤„ç†
    if (count == null || count <= 0) {
        logger.warn("æ•°æ®æ¡æ•°æ— æ•ˆ: {}, ä½¿ç”¨é»˜è®¤å€¼: 1000", count);
        return 1000;
    }
    
    // 2. æœ€å¤§æŸ¥è¯¢é™åˆ¶ï¼ˆé˜²æ­¢å†…å­˜æº¢å‡ºï¼‰
    int maxQueryCount = 1000000; // æœ€å¤§æŸ¥è¯¢100ä¸‡æ¡
    if (count > maxQueryCount) {
        logger.warn("æ•°æ®æ¡æ•°è¶…è¿‡æœ€å¤§é™åˆ¶: {}, é™åˆ¶ä¸º: {}", count, maxQueryCount);
        return maxQueryCount;
    }
    
    return count;
}

/**
 * æ ¡éªŒå¹¶è®¾ç½®é»˜è®¤æ–‡ä»¶å
 */
private String validateAndSetDefaultFileName(String fileName) {
    if (fileName == null || fileName.trim().isEmpty()) {
        fileName = ExcelExportUtil.generateDefaultFileName();
        logger.info("ä½¿ç”¨é»˜è®¤æ–‡ä»¶å: {}", fileName);
    }
    return fileName;
}
```

---

### 5. ExcelExportController - å¯¼å‡ºæ§åˆ¶å™¨

**è®¾è®¡ç›®çš„**ï¼š
- æ¥æ”¶ HTTP è¯·æ±‚
- å‚æ•°è§£æ
- å¼‚å¸¸å¤„ç†
- è¿”å›å“åº”

**æ ¸å¿ƒæ–¹æ³•**ï¼š

```java
@GetMapping("/export")
public void export(HttpServletResponse response,
                  @RequestParam(value = "count", required = false) Integer count,
                  @RequestParam(value = "fileName", required = false) String fileName,
                  @RequestParam(value = "sheetName", required = false) String sheetName) {
    
    logger.info("æ”¶åˆ° Excel å¯¼å‡ºè¯·æ±‚ï¼Œå‚æ•°: count={}, fileName={}, sheetName={}", 
               count, fileName, sheetName);

    try {
        excelExportService.exportData(response, count, fileName, sheetName);
    } catch (IOException e) {
        logger.error("Excel å¯¼å‡ºå¤±è´¥", e);
        handleExportError(response, e);
    } catch (Exception e) {
        logger.error("Excel å¯¼å‡ºå¼‚å¸¸", e);
        handleExportError(response, e);
    }
}
```

**å¼‚å¸¸å¤„ç†**ï¼š

```java
/**
 * å¤„ç†å¯¼å‡ºé”™è¯¯
 * 
 * ç­–ç•¥ï¼š
 * 1. é‡ç½®å“åº”
 * 2. è¿”å› JSON é”™è¯¯ä¿¡æ¯
 * 3. è®¾ç½® HTTP 500 çŠ¶æ€ç 
 */
private void handleExportError(HttpServletResponse response, Exception e) {
    try {
        // 1. é‡ç½®å“åº”ï¼ˆæ¸…é™¤ä¹‹å‰å¯èƒ½å†™å…¥çš„å†…å®¹ï¼‰
        response.reset();
        
        // 2. è®¾ç½®å“åº”ç±»å‹å’ŒçŠ¶æ€ç 
        response.setContentType("application/json;charset=UTF-8");
        response.setStatus(HttpServletResponse.SC_INTERNAL_SERVER_ERROR);
        
        // 3. è¿”å›é”™è¯¯ä¿¡æ¯
        String errorMessage = String.format(
            "{\"success\":false,\"message\":\"å¯¼å‡ºå¤±è´¥: %s\"}", 
            e.getMessage()
        );
        response.getWriter().write(errorMessage);
        response.getWriter().flush();
        
    } catch (IOException ex) {
        logger.error("å†™å…¥é”™è¯¯å“åº”å¤±è´¥", ex);
    }
}
```

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### 1. EasyExcel ä½¿ç”¨

**åŸºç¡€ç”¨æ³•**ï¼š

```java
// 1. å†™å…¥æµ
EasyExcel.write(outputStream)
    .sheet("Sheetåç§°")
    .head(è¡¨å¤´)
    .doWrite(æ•°æ®);

// 2. å†™å…¥æ–‡ä»¶
EasyExcel.write(filePath)
    .sheet("Sheetåç§°")
    .head(è¡¨å¤´)
    .doWrite(æ•°æ®);
```

**åŠ¨æ€è¡¨å¤´**ï¼š

```java
// è¡¨å¤´æ ¼å¼ï¼šList<List<String>>
List<List<String>> headers = new ArrayList<>();
headers.add(Arrays.asList("è®¢å•ç¼–å·"));
headers.add(Arrays.asList("å®¢æˆ·å§“å"));
headers.add(Arrays.asList("è®¢å•é‡‘é¢"));

// æ•°æ®æ ¼å¼ï¼šList<List<Object>>
List<List<Object>> data = new ArrayList<>();
data.add(Arrays.asList("ORD001", "å¼ ä¸‰", 99.99));
data.add(Arrays.asList("ORD002", "æå››", 199.99));

// å¯¼å‡º
EasyExcel.write(outputStream)
    .sheet("è®¢å•")
    .head(headers)
    .doWrite(data);
```

### 2. LinkedHashMap é¡ºåºä¿è¯

**åŸç†**ï¼š

```java
// HashMapï¼šæ— åº
Map<String, Object> hashMap = new HashMap<>();
hashMap.put("å­—æ®µ3", value3);
hashMap.put("å­—æ®µ1", value1);
hashMap.put("å­—æ®µ2", value2);
// éå†é¡ºåºä¸ç¡®å®š

// LinkedHashMapï¼šæœ‰åºï¼ˆæ’å…¥é¡ºåºï¼‰
Map<String, Object> linkedHashMap = new LinkedHashMap<>();
linkedHashMap.put("å­—æ®µ3", value3);  // ç¬¬1ä¸ª
linkedHashMap.put("å­—æ®µ1", value1);  // ç¬¬2ä¸ª
linkedHashMap.put("å­—æ®µ2", value2);  // ç¬¬3ä¸ª
// éå†é¡ºåºï¼šå­—æ®µ3 -> å­—æ®µ1 -> å­—æ®µ2
```

**å†…éƒ¨å®ç°**ï¼š

```java
// LinkedHashMap ç»§æ‰¿è‡ª HashMapï¼Œé¢å¤–ç»´æŠ¤äº†ä¸€ä¸ªåŒå‘é“¾è¡¨
public class LinkedHashMap<K,V> extends HashMap<K,V> {
    // åŒå‘é“¾è¡¨å¤´èŠ‚ç‚¹
    transient LinkedHashMap.Entry<K,V> head;
    
    // åŒå‘é“¾è¡¨å°¾èŠ‚ç‚¹
    transient LinkedHashMap.Entry<K,V> tail;
    
    // èŠ‚ç‚¹å®šä¹‰
    static class Entry<K,V> extends HashMap.Node<K,V> {
        Entry<K,V> before, after;  // å‰é©±å’Œåç»§èŠ‚ç‚¹
    }
}
```

### 3. æµå¼å“åº”åŸç†

**ä¼ ç»Ÿæ–¹å¼ï¼ˆä¸æ¨èï¼‰**ï¼š

```java
// 1. ç”Ÿæˆæ–‡ä»¶
String filePath = "/tmp/export.xlsx";
EasyExcel.write(filePath).sheet("æ•°æ®").doWrite(data);

// 2. è¯»å–æ–‡ä»¶
FileInputStream fis = new FileInputStream(filePath);
OutputStream os = response.getOutputStream();

// 3. å†™å…¥å“åº”
byte[] buffer = new byte[1024];
int len;
while ((len = fis.read(buffer)) != -1) {
    os.write(buffer, 0, len);
}

// 4. åˆ é™¤ä¸´æ—¶æ–‡ä»¶
new File(filePath).delete();
```

**æµå¼æ–¹å¼ï¼ˆæ¨èï¼‰**ï¼š

```java
// ç›´æ¥å†™å…¥å“åº”æµï¼Œæ— ä¸´æ—¶æ–‡ä»¶
OutputStream os = response.getOutputStream();
EasyExcel.write(os).sheet("æ•°æ®").doWrite(data);
os.flush();
os.close();
```

**ä¼˜åŠ¿å¯¹æ¯”**ï¼š

| å¯¹æ¯”é¡¹ | ä¼ ç»Ÿæ–¹å¼ | æµå¼æ–¹å¼ |
|--------|---------|---------|
| **ç£ç›˜IO** | 2æ¬¡ï¼ˆå†™æ–‡ä»¶+è¯»æ–‡ä»¶ï¼‰ | 0æ¬¡ |
| **ç£ç›˜ç©ºé—´** | éœ€è¦ä¸´æ—¶æ–‡ä»¶ | ä¸éœ€è¦ |
| **æ€§èƒ½** | æ…¢ | å¿« |
| **å®‰å…¨æ€§** | ä¸´æ—¶æ–‡ä»¶å¯èƒ½æ³„éœ² | æ— æ³„éœ²é£é™© |
| **å®æ—¶æ€§** | æ–‡ä»¶ç”Ÿæˆåæ‰èƒ½ä¸‹è½½ | å®æ—¶ä¸‹è½½ |

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. æ—¥å¿—è§„èŒƒ

```java
// âœ… æ¨èï¼šç»“æ„åŒ–æ—¥å¿—
logger.info("å¼€å§‹å¯¼å‡º Excelï¼ŒåŸå§‹æ•°æ®é‡: {}", totalCount);
logger.warn("æ•°æ®é‡è¶…è¿‡æœ€å¤§é™åˆ¶ {}ï¼Œå®é™…æ•°æ®é‡: {}ï¼Œå°†åªå¯¼å‡ºå‰ {} æ¡", 
           MAX_EXPORT_ROWS, totalCount, exportCount);

// âŒ ä¸æ¨èï¼šå­—ç¬¦ä¸²æ‹¼æ¥
logger.info("å¼€å§‹å¯¼å‡º Excelï¼ŒåŸå§‹æ•°æ®é‡: " + totalCount);
```

### 2. å¼‚å¸¸å¤„ç†

```java
// âœ… æ¨èï¼šfinally ç¡®ä¿èµ„æºé‡Šæ”¾
OutputStream os = null;
try {
    os = response.getOutputStream();
    // ä¸šåŠ¡é€»è¾‘...
} catch (IOException e) {
    logger.error("å¯¼å‡ºå¤±è´¥", e);
    throw e;
} finally {
    if (os != null) {
        os.flush();
        os.close();
    }
}

// âŒ ä¸æ¨èï¼šä¸å¤„ç†èµ„æºé‡Šæ”¾
OutputStream os = response.getOutputStream();
// ä¸šåŠ¡é€»è¾‘...
// å¦‚æœå¼‚å¸¸ï¼Œæµä¸ä¼šå…³é—­
```

### 3. å‚æ•°æ ¡éªŒ

```java
// âœ… æ¨èï¼šæå‰æ ¡éªŒï¼Œå¿«é€Ÿå¤±è´¥
if (dataList == null || dataList.isEmpty()) {
    throw new IllegalArgumentException("å¯¼å‡ºæ•°æ®ä¸èƒ½ä¸ºç©º");
}

// âŒ ä¸æ¨èï¼šå»¶è¿Ÿæ ¡éªŒ
// å¯èƒ½åœ¨å¤„ç†è¿‡ç¨‹ä¸­æ‰å‘ç°æ•°æ®ä¸ºç©ºï¼Œæµªè´¹èµ„æº
```

### 4. å¸¸é‡ä½¿ç”¨

```java
// âœ… æ¨èï¼šä½¿ç”¨å¸¸é‡
if (totalCount > ExcelConstants.MAX_EXPORT_ROWS) {
    // ...
}

// âŒ ä¸æ¨èï¼šé­”æ³•æ•°å­—
if (totalCount > 100000) {
    // ...
}
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [01-åŠŸèƒ½è®¾è®¡è¯´æ˜.md](./01-åŠŸèƒ½è®¾è®¡è¯´æ˜.md) - åŠŸèƒ½è®¾è®¡
- [03-ä½¿ç”¨ç¤ºä¾‹.md](./03-ä½¿ç”¨ç¤ºä¾‹.md) - ä½¿ç”¨ç¤ºä¾‹
- [README.md](./README.md) - é¡¹ç›®æ€»è§ˆ

---

## ğŸ“ æ€»ç»“

æ ¸å¿ƒä»£ç éµå¾ªä»¥ä¸‹è®¾è®¡åŸåˆ™ï¼š

1. **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªç±»åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½
2. **å¼€é—­åŸåˆ™**ï¼šå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
3. **ä¾èµ–å€’ç½®**ï¼šä¾èµ–æŠ½è±¡è€Œéå…·ä½“å®ç°
4. **æœ€å°‘çŸ¥è¯†**ï¼šç±»ä¹‹é—´ä½è€¦åˆ
5. **ä»£ç æ•´æ´**ï¼šå‘½åæ¸…æ™°ï¼Œæ³¨é‡Šå®Œå–„

å…³é”®æŠ€æœ¯ç‚¹ï¼š
- âœ… LinkedHashMap ä¿è¯å­—æ®µé¡ºåº
- âœ… EasyExcel æµå¼å†™å…¥
- âœ… å“åº”å¤´ä¼ é€’å…ƒæ•°æ®
- âœ… æ•°æ®æˆªæ–­é˜²æ­¢å†…å­˜æº¢å‡º
- âœ… ä¸­æ–‡æ–‡ä»¶å URL ç¼–ç 
- âœ… èµ„æºç®¡ç†ç¡®ä¿é‡Šæ”¾
