# 01-å¤šæ•°æ®æºé…ç½®è¯´æ˜

## ğŸ“Œ é…ç½®æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº† MyBatis å¤šæ•°æ®æºé…ç½®ï¼Œæ”¯æŒåŒæ—¶è¿æ¥ä¸¤ä¸ª MySQL æ•°æ®åº“ã€‚

### æ•°æ®æºä¿¡æ¯

| æ•°æ®æº | æ•°æ®åº“å | æ ‡è¯† | MapperåŒ…è·¯å¾„ | XMLè·¯å¾„ | å®ä½“ç±»åŒ…è·¯å¾„ |
|--------|---------|------|-------------|---------|-------------|
| ä¸»æ•°æ®æº | springboot_db | primary | com.huabin.multids.db1.mapper | classpath:mapper/db1/*.xml | com.huabin.multids.db1.entity |
| ä»æ•°æ®æº | springboot_db2 | secondary | com.huabin.multids.db2.mapper | classpath:mapper/db2/*.xml | com.huabin.multids.db2.entity |

---

## ğŸ”§ æ ¸å¿ƒé…ç½®æ–‡ä»¶

### 1. application.yml

é…ç½®æ–‡ä»¶ä½ç½®ï¼š`src/main/resources/application.yml`

```yaml
spring:
  datasource:
    # ä¸»æ•°æ®æºé…ç½®
    primary:
      jdbc-url: jdbc:mysql://localhost:3306/springboot_db?...
      username: springboot
      password: Huabin123$
      driver-class-name: com.mysql.cj.jdbc.Driver
      hikari:
        pool-name: PrimaryHikariPool
        maximum-pool-size: 20
    
    # ä»æ•°æ®æºé…ç½®
    secondary:
      jdbc-url: jdbc:mysql://localhost:3306/springboot_db2?...
      username: springboot
      password: Huabin123$
      driver-class-name: com.mysql.cj.jdbc.Driver
      hikari:
        pool-name: SecondaryHikariPool
        maximum-pool-size: 20
```

**å…³é”®é…ç½®è¯´æ˜ï¼š**

1. **jdbc-url vs url**
   - å¤šæ•°æ®æºå¿…é¡»ä½¿ç”¨ `jdbc-url`
   - å•æ•°æ®æºå¯ä»¥ä½¿ç”¨ `url`

2. **è¿æ¥æ± é…ç½®**
   - ä½¿ç”¨ HikariCPï¼ˆSpring Boot é»˜è®¤ï¼‰
   - æ¯ä¸ªæ•°æ®æºç‹¬ç«‹çš„è¿æ¥æ± 
   - pool-name ç”¨äºåŒºåˆ†ä¸åŒçš„è¿æ¥æ± 

3. **è¿æ¥å‚æ•°**
   - `useUnicode=true&characterEncoding=utf8`ï¼šå­—ç¬¦ç¼–ç 
   - `serverTimezone=Asia/Shanghai`ï¼šæ—¶åŒºè®¾ç½®
   - `useSSL=false`ï¼šç¦ç”¨ SSLï¼ˆå¼€å‘ç¯å¢ƒï¼‰
   - `allowPublicKeyRetrieval=true`ï¼šå…è®¸å…¬é’¥æ£€ç´¢

---

### 2. ä¸»æ•°æ®æºé…ç½®ç±»

é…ç½®æ–‡ä»¶ï¼š`src/main/java/com/huabin/multids/config/PrimaryDataSourceConfig.java`

```java
@Configuration
@MapperScan(
    basePackages = "com.huabin.multids.db1.mapper",
    sqlSessionFactoryRef = "primarySqlSessionFactory"
)
public class PrimaryDataSourceConfig {
    
    @Primary
    @Bean(name = "primaryDataSource")
    @ConfigurationProperties(prefix = "spring.datasource.primary")
    public DataSource primaryDataSource() {
        return DataSourceBuilder.create()
                .type(HikariDataSource.class)
                .build();
    }
    
    @Primary
    @Bean(name = "primarySqlSessionFactory")
    public SqlSessionFactory primarySqlSessionFactory(
            @Qualifier("primaryDataSource") DataSource dataSource) throws Exception {
        // é…ç½® SqlSessionFactory
    }
    
    @Primary
    @Bean(name = "primaryTransactionManager")
    public DataSourceTransactionManager primaryTransactionManager(
            @Qualifier("primaryDataSource") DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }
}
```

**å…³é”®æ³¨è§£è¯´æ˜ï¼š**

1. **@Primary**
   - æ ‡è®°ä¸ºä¸»æ•°æ®æº
   - å½“æœ‰å¤šä¸ªç›¸åŒç±»å‹çš„ Bean æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨æ­¤ Bean
   - åªèƒ½æœ‰ä¸€ä¸ªæ•°æ®æºä½¿ç”¨ @Primary

2. **@MapperScan**
   - æ‰«æ Mapper æ¥å£æ‰€åœ¨çš„åŒ…
   - `basePackages`ï¼šæŒ‡å®š Mapper åŒ…è·¯å¾„
   - `sqlSessionFactoryRef`ï¼šæŒ‡å®šä½¿ç”¨çš„ SqlSessionFactory

3. **@ConfigurationProperties**
   - è‡ªåŠ¨ç»‘å®šé…ç½®æ–‡ä»¶ä¸­çš„å±æ€§
   - `prefix`ï¼šæŒ‡å®šé…ç½®å‰ç¼€

4. **@Qualifier**
   - æŒ‡å®šè¦æ³¨å…¥çš„ Bean åç§°
   - ç”¨äºåŒºåˆ†å¤šä¸ªç›¸åŒç±»å‹çš„ Bean

---

### 3. ä»æ•°æ®æºé…ç½®ç±»

é…ç½®æ–‡ä»¶ï¼š`src/main/java/com/huabin/multids/config/SecondaryDataSourceConfig.java`

```java
@Configuration
@MapperScan(
    basePackages = "com.huabin.multids.db2.mapper",
    sqlSessionFactoryRef = "secondarySqlSessionFactory"
)
public class SecondaryDataSourceConfig {
    
    // æ³¨æ„ï¼šä¸ä½¿ç”¨ @Primary æ³¨è§£
    
    @Bean(name = "secondaryDataSource")
    @ConfigurationProperties(prefix = "spring.datasource.secondary")
    public DataSource secondaryDataSource() {
        return DataSourceBuilder.create()
                .type(HikariDataSource.class)
                .build();
    }
    
    @Bean(name = "secondarySqlSessionFactory")
    public SqlSessionFactory secondarySqlSessionFactory(
            @Qualifier("secondaryDataSource") DataSource dataSource) throws Exception {
        // é…ç½® SqlSessionFactory
    }
    
    @Bean(name = "secondaryTransactionManager")
    public DataSourceTransactionManager secondaryTransactionManager(
            @Qualifier("secondaryDataSource") DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }
}
```

**ä¸ä¸»æ•°æ®æºçš„åŒºåˆ«ï¼š**

1. ä¸ä½¿ç”¨ `@Primary` æ³¨è§£
2. Bean åç§°ä¸åŒï¼ˆsecondary å‰ç¼€ï¼‰
3. Mapper åŒ…è·¯å¾„ä¸åŒ
4. é…ç½®å‰ç¼€ä¸åŒ

---

### 4. å¯åŠ¨ç±»é…ç½®

é…ç½®æ–‡ä»¶ï¼š`src/main/java/com/huabin/multids/MultiDataSourceApplication.java`

```java
@SpringBootApplication(exclude = {DataSourceAutoConfiguration.class})
public class MultiDataSourceApplication {
    public static void main(String[] args) {
        SpringApplication.run(MultiDataSourceApplication.class, args);
    }
}
```

**å…³é”®é…ç½®ï¼š**

- `exclude = {DataSourceAutoConfiguration.class}`
- æ’é™¤ Spring Boot çš„æ•°æ®æºè‡ªåŠ¨é…ç½®
- å› ä¸ºæˆ‘ä»¬ä½¿ç”¨è‡ªå®šä¹‰çš„å¤šæ•°æ®æºé…ç½®
- å¦‚æœä¸æ’é™¤ï¼Œä¼šå¯¼è‡´é…ç½®å†²çª

**æ³¨æ„äº‹é¡¹ï¼š**

- âŒ ä¸è¦åœ¨å¯åŠ¨ç±»ä¸Šä½¿ç”¨ `@MapperScan`
- âœ… æ‰€æœ‰ `@MapperScan` é…ç½®éƒ½åœ¨æ•°æ®æºé…ç½®ç±»ä¸­å®Œæˆ

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
src/main/java/com/huabin/multids/
â”œâ”€â”€ config/                          # é…ç½®ç±»
â”‚   â”œâ”€â”€ PrimaryDataSourceConfig.java    # ä¸»æ•°æ®æºé…ç½®
â”‚   â””â”€â”€ SecondaryDataSourceConfig.java  # ä»æ•°æ®æºé…ç½®
â”œâ”€â”€ db1/                             # ä¸»æ•°æ®æºç›¸å…³
â”‚   â”œâ”€â”€ entity/                         # å®ä½“ç±»
â”‚   â”‚   â””â”€â”€ User.java
â”‚   â””â”€â”€ mapper/                         # Mapperæ¥å£
â”‚       â””â”€â”€ UserMapper.java
â”œâ”€â”€ db2/                             # ä»æ•°æ®æºç›¸å…³
â”‚   â”œâ”€â”€ entity/                         # å®ä½“ç±»
â”‚   â”‚   â””â”€â”€ Product.java
â”‚   â””â”€â”€ mapper/                         # Mapperæ¥å£
â”‚       â””â”€â”€ ProductMapper.java
â”œâ”€â”€ service/                         # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ UserService.java                # ç”¨æˆ·æœåŠ¡ï¼ˆä¸»æ•°æ®æºï¼‰
â”‚   â””â”€â”€ ProductService.java             # äº§å“æœåŠ¡ï¼ˆä»æ•°æ®æºï¼‰
â”œâ”€â”€ controller/                      # æ§åˆ¶å™¨å±‚
â”‚   â”œâ”€â”€ UserController.java             # ç”¨æˆ·æ§åˆ¶å™¨
â”‚   â””â”€â”€ ProductController.java          # äº§å“æ§åˆ¶å™¨
â””â”€â”€ MultiDataSourceApplication.java  # å¯åŠ¨ç±»

src/main/resources/
â”œâ”€â”€ mapper/                          # Mapper XMLæ–‡ä»¶
â”‚   â”œâ”€â”€ db1/                            # ä¸»æ•°æ®æºXML
â”‚   â”‚   â””â”€â”€ UserMapper.xml
â”‚   â””â”€â”€ db2/                            # ä»æ•°æ®æºXML
â”‚       â””â”€â”€ ProductMapper.xml
â”œâ”€â”€ generator/                       # ä»£ç ç”Ÿæˆå™¨é…ç½®
â”‚   â”œâ”€â”€ generatorConfig-db1.xml         # ä¸»æ•°æ®æºç”Ÿæˆé…ç½®
â”‚   â””â”€â”€ generatorConfig-db2.xml         # ä»æ•°æ®æºç”Ÿæˆé…ç½®
â””â”€â”€ application.yml                  # åº”ç”¨é…ç½®æ–‡ä»¶
```

---

## âš™ï¸ é…ç½®è¦ç‚¹

### 1. Bean å‘½åè§„èŒƒ

| ç»„ä»¶ | ä¸»æ•°æ®æº | ä»æ•°æ®æº |
|------|---------|---------|
| DataSource | primaryDataSource | secondaryDataSource |
| SqlSessionFactory | primarySqlSessionFactory | secondarySqlSessionFactory |
| TransactionManager | primaryTransactionManager | secondaryTransactionManager |
| SqlSessionTemplate | primarySqlSessionTemplate | secondarySqlSessionTemplate |

**è§„åˆ™ï¼š**
- ä¸»æ•°æ®æºä½¿ç”¨ `primary` å‰ç¼€
- ä»æ•°æ®æºä½¿ç”¨ `secondary` å‰ç¼€
- ä¿æŒå‘½åä¸€è‡´æ€§ï¼Œä¾¿äºç»´æŠ¤

### 2. åŒ…è·¯å¾„è§„èŒƒ

| ç±»å‹ | ä¸»æ•°æ®æº | ä»æ•°æ®æº |
|------|---------|---------|
| Mapperæ¥å£ | com.huabin.multids.db1.mapper | com.huabin.multids.db2.mapper |
| å®ä½“ç±» | com.huabin.multids.db1.entity | com.huabin.multids.db2.entity |
| XMLæ–‡ä»¶ | mapper/db1/*.xml | mapper/db2/*.xml |

**è§„åˆ™ï¼š**
- ä½¿ç”¨ `db1`ã€`db2` åŒºåˆ†ä¸åŒæ•°æ®æº
- åŒ…è·¯å¾„å¿…é¡»ä¸åŒï¼Œé¿å…å†²çª
- XML æ–‡ä»¶è·¯å¾„ä¸åŒ…è·¯å¾„å¯¹åº”

### 3. äº‹åŠ¡ç®¡ç†

**ä¸»æ•°æ®æºäº‹åŠ¡ï¼š**
```java
// æ–¹å¼1ï¼šé»˜è®¤ä½¿ç”¨ä¸»æ•°æ®æºäº‹åŠ¡ç®¡ç†å™¨
@Transactional
public void method() { }

// æ–¹å¼2ï¼šæ˜ç¡®æŒ‡å®šäº‹åŠ¡ç®¡ç†å™¨
@Transactional(transactionManager = "primaryTransactionManager")
public void method() { }
```

**ä»æ•°æ®æºäº‹åŠ¡ï¼š**
```java
// å¿…é¡»æ˜ç¡®æŒ‡å®šäº‹åŠ¡ç®¡ç†å™¨
@Transactional(transactionManager = "secondaryTransactionManager")
public void method() { }
```

**é‡è¦æç¤ºï¼š**
- ä¸»æ•°æ®æºå¯ä»¥çœç•¥ `transactionManager` å‚æ•°
- ä»æ•°æ®æºå¿…é¡»æ˜ç¡®æŒ‡å®š `transactionManager`
- å¦åˆ™ä¼šä½¿ç”¨é»˜è®¤çš„ä¸»æ•°æ®æºäº‹åŠ¡ç®¡ç†å™¨ï¼Œå¯¼è‡´äº‹åŠ¡å¤±æ•ˆ

---

## ğŸ” å¸¸è§é—®é¢˜

### 1. æ•°æ®æºé…ç½®ä¸ç”Ÿæ•ˆ

**é—®é¢˜ï¼š** å¯åŠ¨æŠ¥é”™ï¼Œæ‰¾ä¸åˆ°æ•°æ®æºé…ç½®

**åŸå› ï¼š**
- é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨äº† `url` è€Œä¸æ˜¯ `jdbc-url`
- å¤šæ•°æ®æºå¿…é¡»ä½¿ç”¨ `jdbc-url`

**è§£å†³ï¼š**
```yaml
# âŒ é”™è¯¯
spring:
  datasource:
    primary:
      url: jdbc:mysql://...

# âœ… æ­£ç¡®
spring:
  datasource:
    primary:
      jdbc-url: jdbc:mysql://...
```

### 2. Mapper æ³¨å…¥å¤±è´¥

**é—®é¢˜ï¼š** `Field xxxMapper required a bean that could not be found`

**åŸå› ï¼š**
- `@MapperScan` çš„åŒ…è·¯å¾„é…ç½®é”™è¯¯
- Mapper æ¥å£ä¸åœ¨æ‰«æè·¯å¾„ä¸‹

**è§£å†³ï¼š**
- æ£€æŸ¥ `@MapperScan` çš„ `basePackages` é…ç½®
- ç¡®ä¿ Mapper æ¥å£åœ¨æ­£ç¡®çš„åŒ…ä¸‹

### 3. äº‹åŠ¡ä¸ç”Ÿæ•ˆ

**é—®é¢˜ï¼š** ä»æ•°æ®æºçš„äº‹åŠ¡å›æ»šå¤±è´¥

**åŸå› ï¼š**
- ä½¿ç”¨ä»æ•°æ®æºæ—¶ï¼ŒæœªæŒ‡å®šäº‹åŠ¡ç®¡ç†å™¨
- é»˜è®¤ä½¿ç”¨äº†ä¸»æ•°æ®æºçš„äº‹åŠ¡ç®¡ç†å™¨

**è§£å†³ï¼š**
```java
// âŒ é”™è¯¯ï¼šä»æ•°æ®æºæœªæŒ‡å®šäº‹åŠ¡ç®¡ç†å™¨
@Transactional
public void method() {
    productMapper.insert(product);
}

// âœ… æ­£ç¡®ï¼šæ˜ç¡®æŒ‡å®šä»æ•°æ®æºçš„äº‹åŠ¡ç®¡ç†å™¨
@Transactional(transactionManager = "secondaryTransactionManager")
public void method() {
    productMapper.insert(product);
}
```

### 4. XML æ–‡ä»¶æ‰¾ä¸åˆ°

**é—®é¢˜ï¼š** `Invalid bound statement (not found)`

**åŸå› ï¼š**
- XML æ–‡ä»¶è·¯å¾„é…ç½®é”™è¯¯
- XML æ–‡ä»¶çš„ namespace ä¸ Mapper æ¥å£ä¸åŒ¹é…

**è§£å†³ï¼š**
- æ£€æŸ¥ `SqlSessionFactory` ä¸­çš„ `mapperLocations` é…ç½®
- ç¡®ä¿ XML æ–‡ä»¶çš„ namespace ä¸ Mapper æ¥å£å…¨é™å®šåä¸€è‡´

---

## âœ… é…ç½®æ£€æŸ¥æ¸…å•

- [ ] application.yml ä¸­ä½¿ç”¨ `jdbc-url` è€Œä¸æ˜¯ `url`
- [ ] ä¸»æ•°æ®æºé…ç½®ç±»ä½¿ç”¨ `@Primary` æ³¨è§£
- [ ] ä»æ•°æ®æºé…ç½®ç±»ä¸ä½¿ç”¨ `@Primary` æ³¨è§£
- [ ] æ‰€æœ‰ Bean åç§°ä¸é‡å¤
- [ ] Mapper åŒ…è·¯å¾„ä¸é‡å¤
- [ ] XML æ–‡ä»¶è·¯å¾„ä¸é‡å¤
- [ ] å¯åŠ¨ç±»æ’é™¤äº† `DataSourceAutoConfiguration`
- [ ] å¯åŠ¨ç±»æ²¡æœ‰ä½¿ç”¨ `@MapperScan`
- [ ] ä»æ•°æ®æºçš„äº‹åŠ¡æ˜ç¡®æŒ‡å®šäº† `transactionManager`
- [ ] XML æ–‡ä»¶çš„ namespace ä¸ Mapper æ¥å£åŒ¹é…

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [02-ä»£ç ç”Ÿæˆå™¨ä½¿ç”¨æŒ‡å—.md](./02-ä»£ç ç”Ÿæˆå™¨ä½¿ç”¨æŒ‡å—.md)
- [03-ä½¿ç”¨ç¤ºä¾‹.md](./03-ä½¿ç”¨ç¤ºä¾‹.md)
- [README.md](./README.md)
